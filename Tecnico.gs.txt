/****************************************************
 * FILE TECNICO
 * Funzioni di manutenzione, backup, test e verifica
 * NON usate nel lavoro quotidiano
 ****************************************************/

function BONIFICA_EVIDENZA_OGGI() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName("Settimana Attiva");
  if (!sh) return;

  // 1) Pulizia aggressiva: elimina colori "incollati" in A2:L20
  // (non tocca contenuti)
  sh.getRange("A2:L20").setBackground(null);

  // 2) Rimette a posto CF vitali + UI N1/N2/N3 + riparazioni leggere
  HEALTHCHECK_VISIVO();

  // 3) Cintura + bretelle: regola "OGGI" con priorit√† alta
  RIPRISTINA_EVIDENZIA_OGGI();

  try { ss.toast("Bonifica fatta ‚úÖ", "Tecnico", 4); } catch (e) {}
}

/**
 * Backup manuale immediato
 */
function MANUALE_Backup_Crea() {
  const info = creaBackupPrimaDiArchiviazione_();
  SpreadsheetApp.getUi().alert("Backup creato:\n\n" + info.name);
}

/**
 * Pulisce backup vecchi (mantiene ultimi 60)
 */
function MANUALE_Backup_Pulisci60() {
  pulisciBackupVecchi_(60);
  SpreadsheetApp.getUi().alert("Pulizia backup completata (ultimi 60 mantenuti).");
}

/**
 * Info ultimo backup
 */
function MANUALE_Backup_InfoUltimo() {
  const props = PropertiesService.getDocumentProperties();
  const name = props.getProperty("last_backup_name") || "(nessuno)";
  const time = props.getProperty("last_backup_time");
  const when = time ? new Date(Number(time)).toLocaleString("it-IT") : "(n/a)";
  SpreadsheetApp.getUi().alert(
    "Ultimo backup:\n\nNome: " + name + "\nQuando: " + when
  );
}

function TECNICO_ProteggiTemplateSettimana() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName("TemplateSettimana");
  if (!sh) throw new Error("Manca TemplateSettimana");

  const ranges = ["A3:A20","C3:C20","E3:E20","G3:G20","I3:I20","K3:K20"];
  const rngList = sh.getRangeList(ranges);

  const me = Session.getEffectiveUser().getEmail();
  const protections = rngList.getRanges().map(r => r.protect());

  protections.forEach(p => {
    p.setDescription("Protezione NOMI template");
    try { p.removeEditors(p.getEditors()); } catch(e) {}
    if (me) { try { p.addEditor(me); } catch(e) {} }
    try { p.setDomainEdit(false); } catch(e) {}
  });

  SpreadsheetApp.getActive().toast("‚úÖ TemplateSettimana protetto (celle NOMI)", "Tecnico", 4);
}

/****************************************************
 * FIX HARD VALIDAZIONI UI (N18 + eventuali ‚Äúcontagi‚Äù tipo L3)
 * - Ripulisce data validation ‚Äúsbagliate‚Äù
 * - Ricrea N18 come checkbox pulita
 ****************************************************/
function TECNICO_FIX_VALIDAZIONI_UI_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName("Settimana Attiva");
  if (!sh) return SpreadsheetApp.getUi().alert("Manca 'Settimana Attiva'.");

  // 1) Pulisci eventuali validazioni ‚Äúsporche‚Äù su N18 e L3
  // (L3 lo cito perch√© hai visto l‚Äôerrore apparire l√¨)
  const targets = ["N18", "L3"];
  for (const a1 of targets) {
    try {
      const cell = sh.getRange(a1);
      cell.clearDataValidations();

      // Se era rimasto un valore ‚Äústrano‚Äù dentro, puliscilo
      // (NON facciamo clearFormat per non rovinare il foglio)
      const v = cell.getValue();
      if (v !== "" && v !== true && v !== false) cell.clearContent();
    } catch (e) {}
  }

  // 2) Ricrea N18 come checkbox ‚Äúpulita‚Äù
  try {
    const n18 = sh.getRange("N18");
    n18.clearDataValidations();
    n18.clearContent();
    n18.insertCheckboxes();
    n18.setValue(false);
    n18.setHorizontalAlignment("center").setVerticalAlignment("middle");
  } catch (e) {}

  SpreadsheetApp.getActive().toast("Fix validazioni UI completato ‚úÖ", "Tecnico", 4);
}

function TECNICO_RipristinoCompletoAttiva() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName("Settimana Attiva");
  if (!sh) throw new Error("Manca Settimana Attiva");

  try { garantisciStruttura(); } catch(e) {}
  try { HEALTHCHECK_VISIVO(); } catch(e) {}
  try { RIPRISTINA_EVIDENZIA_OGGI(); } catch(e) {}
  try { AGGIORNA_HEADER_OGGI_SAFE_(); } catch(e) {}
  try { _cbClearRange_("Settimana Attiva", 3, 20, [2,4,6,8,10,12]); } catch(e) {}

  try {
    const pairs = [
      { n:1, c:2 }, { n:3, c:4 }, { n:5, c:6 }, { n:7, c:8 }, { n:9, c:10 }, { n:11, c:12 },
    ];
    const startRow = 3, endRow = 20;
    for (const p of pairs) {
      const names = sh.getRange(startRow, p.n, endRow-startRow+1, 1).getValues();
      for (let i = 0; i < names.length; i++) {
        const row = startRow + i;
        const raw = names[i][0];
        const txt = _normNome_(raw);
        const cb = sh.getRange(row, p.c);

        if (txt) cb.insertCheckboxes();
        else { cb.clearContent(); cb.clearDataValidations(); }
      }
    }
  } catch(e) {}

  SpreadsheetApp.flush();
  ss.toast("‚úÖ Ripristino completo fatto", "Tecnico", 5);
}

/**
 * Storico: prepara foglio
 */
function MANUALE_Storico_Prepara() {
  const sh = getStoricoSettimane_();
  SpreadsheetApp.getUi().alert("Storico pronto: '" + sh.getName() + "'.");
}

/**
 * Storico: scrive intestazione manuale
 */
function MANUALE_Storico_ScriviIntestazione() {
  const ss = SpreadsheetApp.getActive();
  const attiva = ss.getSheetByName("Settimana Attiva");
  if (!attiva) return SpreadsheetApp.getUi().alert("Manca 'Settimana Attiva'.");

  const dataBase = attiva.getRange("M2").getValue();
  if (!(dataBase instanceof Date)) return SpreadsheetApp.getUi().alert("M2 non √® una data valida.");

  const storico = getStoricoSettimane_();
  scriviIntestazioneArchiviazione_(storico, dataBase);
  SpreadsheetApp.getUi().alert("Intestazione storico scritta.");
}

/**
 * Test giornata email
 */
function MANUALE_Email_TestGiornataConsente() {
  const ok = giornataConsenteEmail();
  SpreadsheetApp.getUi().alert(ok ? "‚úÖ Oggi CONSENTE email" : "‚õî Oggi BLOCCA email");
}

function MANUT_Backup_Pulisci60_() {
  pulisciBackupVecchi_(60);
  SpreadsheetApp.getUi().alert("Pulizia backup completata (ultimi 60 mantenuti).");
}

function MANUT_Backup_InfoUltimo_() {
  const props = PropertiesService.getDocumentProperties();
  const name = props.getProperty("last_backup_name") || "(nessuno)";
  const time = props.getProperty("last_backup_time");
  const when = time ? new Date(Number(time)).toLocaleString("it-IT") : "(n/a)";
  SpreadsheetApp.getUi().alert("Ultimo backup:\n\nNome: " + name + "\nQuando: " + when);
}

function MANUT_Email_TestGiornataConsente_() {
  const ok = giornataConsenteEmail();
  SpreadsheetApp.getUi().alert(ok ? "‚úÖ Oggi CONSENTE email" : "‚õî Oggi BLOCCA email");
}

function MANUT_Storico_ScriviIntestazione_() {
  const ss = SpreadsheetApp.getActive();
  const attiva = ss.getSheetByName("Settimana Attiva");
  if (!attiva) return SpreadsheetApp.getUi().alert("Manca 'Settimana Attiva'.");

  const dataBase = attiva.getRange("M2").getValue();
  if (!(dataBase instanceof Date)) return SpreadsheetApp.getUi().alert("M2 non √® una data valida.");

  const storico = getStoricoSettimane_();
  scriviIntestazioneArchiviazione_(storico, dataBase);
  SpreadsheetApp.getUi().alert("Intestazione storico scritta.");
}

function BUILD_MENUS_() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu("TEST")
    .addItem("Ping", "PING_")
    .addToUi();
}

function BUILD_MENUS_() {
  const ui = SpreadsheetApp.getUi();

  ui.createMenu("üì¶ Gestione Settimana")
    .addItem("‚ûï Crea prossima settimana", "richiediCreazioneProssimaSettimana")
    .addItem("üì¶ Archivia settimana", "archiviaSettimana")
    .addItem("üß® Elimina Prossima settimana (FORZATO)", "ELIMINA_PROSSIMA_SETTIMANA_FORZATA")
    .addSeparator()
    .addItem("üë§ Imposta mio nome (Log)", "IMPOSTA_MIO_NOME_LOG")
    .addItem("ü©∫ Healthcheck visivo", "HEALTHCHECK_VISIVO")
    .addItem("üßΩ Mini-fix formattazione tabella", "MINI_FIX_FORMAT_TAB_FORNITORI_")
    .addItem("‚ùì Aiuto rapido", "AIUTO_RAPIDO")
    .addToUi();

  ui.createMenu("üîß Tecnico")
    .addItem("üíæ Backup immediato", "creaBackupPrimaDiArchiviazione_")
    .addItem("üßπ Pulisci backup vecchi (60)", "MANUT_Backup_Pulisci60_")
    .addItem("‚ÑπÔ∏è Info ultimo backup", "MANUT_Backup_InfoUltimo_")
    .addSeparator()
    .addItem("üìö Prepara storico", "getStoricoSettimane_")
    .addItem("üìù Scrivi intestazione storico", "MANUT_Storico_ScriviIntestazione_")
    .addSeparator()
    .addItem("üìß Test: giornata consente email?", "MANUT_Email_TestGiornataConsente_")
    .addSeparator()
    .addItem("üîß Ripara struttura fogli", "garantisciStruttura")
    .addItem("üßΩ Bonifica evidenza OGGI", "BONIFICA_EVIDENZA_OGGI")
    .addItem("‚òëÔ∏è Fix checkbox Template", "FIX_CHECKBOX_TEMPLATE")
    .addItem("üîí Proteggi TemplateSettimana", "TECNICO_ProteggiTemplateSettimana")
    .addItem("üßØ Ripristino completo Attiva", "TECNICO_RipristinoCompletoAttiva")
    .addToUi();
}